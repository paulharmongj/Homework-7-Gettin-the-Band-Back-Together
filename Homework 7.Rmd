---
title: 'Homework 7:'
author: "Paul Harmon, Jacob Dym, and Justin Gomez"
date: "October 20, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=F,message=F,comment=NA,fig.width=5,fig.height=3.5)
```

1) _We are going to be exploring a more complete model that includes a long-term trend and a seasonal component. We need to pick the type of trend and the form of the seasonal component. For the long term trend, consider the following options: no trend, linear trend, or quadratic trend. For the seasonal component, consider no seasonal component, seasonal means, single harmonic pair (m=1), and 5th order harmonic (m=5). Consider all combinations of these components, fit using `lm`.  Create a table that contains the model description, model used DF (so the count of free parameters), AICs, and $\Delta$AICs, sorting the table by AIcs. Use this information to discuss the top model selected (what was in it), the strength of support for that model versus the others, and the strength of evidence for a long-term trend and seasonal component (of the type selected) versus not including them in the model._ 

  - __You should be creating a table that contains twelve models.__

The table below dispalys information for the twelve models created with different combinations of trends and seasonal components. The table has been sorted by AIC for each model, from lowest to highest, allowing us to essentially rank the models in terms of fit. The lowest AIC is the "best" model. In this case, the best choice is the model with a linear trend and single __harmon__ic.

```{r prob1,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
#read in the data
CGO <- read.table("ftp://aftp.cmdl.noaa.gov/data/trace_gases/co2/flask/surface/co2_cgo_surface-flask_1_ccgg_month.txt",header=T)
colnames(CGO) = c("Site", "Year", "Month", "Value")

CGOts<-ts(CGO$Value,start=c(1984,5),freq=12)
YearF <- as.vector(time(CGOts))
MonthF <- as.factor(cycle(CGOts))
library(TSA)

#m1 - no trend, no seasonal component
m1<-lm(CGO$Value~1)
fits1<-fitted(m1)

#m2 - no trend, seasonal means
m2<-lm(CGO$Value~1+MonthF)
fits2<-fitted(m2)

#m3 - no trend, single harm
m3<-lm(CGO$Value~1+harmonic(CGOts,m=1))
fits3<-fitted(m3)

#m4 - no trend, 5th order harm
m4<-lm(CGO$Value~1+harmonic(CGOts,m=5))
fits4<-fitted(m4)

#m5 - linear trend, no season
m5<-lm(CGO$Value~YearF)
fits5<-fitted(m5)

#m6 - linear trend, seasonal means
m6<-lm(CGO$Value~YearF+MonthF)
fits6<-fitted(m6)

#m7 - linear trend, single harm
m7<-lm(CGO$Value~YearF+harmonic(CGOts,m=1))
fits7<-fitted(m7)

#m8 - linear trend, 5th order harm
m8<-lm(CGO$Value~YearF+harmonic(CGOts,m=5))
fits8<-fitted(m8)

#m9 - quad trend, no season
m9<-lm(CGO$Value~YearF^2)
fits9<-fitted(m9)

#m10 - quad trend, seasonal means
m10<-lm(CGO$Value~YearF^2+MonthF)
fits10<-fitted(m10)

#m11 - quad trend, single order harm
m11<-lm(CGO$Value~YearF^2+harmonic(CGOts,m=1))
fits11<-fitted(m11)

#m12 - quad trend, 5th order harm
m12<-lm(CGO$Value~YearF^2+harmonic(CGOts,m=5))
fits12<-fitted(m12)

#real inefficient code...
allthefits<-cbind(fits1,fits2,fits3,fits4,fits5,fits6,fits7,fits8,fits9,fits10,fits11,fits12)
matplot(YearF,allthefits,type="l",col=1:12,lty=1:12)
```


```{r table1,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
library(pander)
alltheAICs<-AIC(m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12)
changeinAIC<-rep(12,12)
baseline<-alltheAICs$AIC[1]
for(i in 1:12) {
  changeinAIC[i]<-baseline-alltheAICs$AIC[i]
}
unsorted<-data.frame(cbind(alltheAICs,changeinAIC))
rownames(unsorted)<-c("No trend, no seasonal component","No trend, seasonal means","No trend, single harmonic","No trend, 5th order harmonic","Linear trend, no seasonal component","Linear trend, seasonl means","Linear trend, single harmonic","Linear trend, 5th order trend","Quad trend, no seasonal component","Quad trend, seasonal means","Quad trend, single harmonic","Quad trend, 5th order harmonic")
colnames(unsorted)<-c("Num. of free pars","AIC","Change in AIC")
sorted<-unsorted[order(unsorted$AIC),]
pandoc.table(sorted)
```
  

2) _Now fit a `gam` from the `mgcv` package that includes a long-term trend based on a thin-plate spline with shrinkage that uses `k=#years,bs="ts"` from the fractional year variable and a cyclic spline seasonal component. To build the cyclic spline component, use the numerically coded month variable that goes from 1 to 12 and `k=12,bs="cc"`. Fit the model, plot the long-term trend and the seasonal component and discuss the estimated components, using both the plots and the EDF of each term._
```{r prob2,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
library(mgcv)
gam.model<-gam(CGOts~s(time(CGOts),k=31,bs="ts")+s(CGO$Month,k=12,bs="cc"))
plot(gam.model)
plot(gam.model)
summary(gam.model)
```


3) _Calculate the AIC of the GAM using the `AIC` function and discuss how that result compares to your AICs in #1. How is it similar or different in terms of information (degrees of freedom) used?_
```{r prob3,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
AIC(gam.model)
```


4) _Compare the fitted values of your GAM to those from your top model, plotting the two models's results and the responses vs time on the same plot._
```{r prob4,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
topfit<-fitted(m7)
gamfit<-fitted(gam.model)
plot(CGOts,col="hotpink",lwd=4)
lines(topfit~YearF,type="l",col="red",lwd=3)
lines(gamfit~YearF,type="l",col="blue",lwd=3,lty=2)
```

## A simulation study with autocorrelation present

5) _Revisit your simulation with an AR(1) from HW 6 \# 10. Consider fitting a model with autocorrelation in it using `gls` from the `nlme` package that accounts for an MA(1) error and another that accounts for an AR(1) error. Run your simulation code, extracting the p-values from the two model summaries and estimate the type I error rate in each situation and compare it to what you get from the regular linear model._ 

- _In a `gls` model summary, the estimates, SEs, test statistics, and p-values are contained in the `tTable` part of the summary. It has a similar layout to `coef` that we pulled the [2,4] element from to get the p-value from `lm`._

```{r prob 5,tidy=TRUE,tidy.opts=list(width.cutoff=50)}
library(nlme)
```

## Some derivation practice (these can be handwritten). If you have not completed STAT 421 or equivalent, please try the problem and then take advantage of advanced help by stopping by to chat about your answer. 

6) _Answer Cryer and Chan question 2.4 (page 20)_
__Please see handwritten solutions to this problem. Thanks!__


7) _Suppose that we are interested in the properties of a local average (linear filter) of two observations from an original time series, $xt$. The new series is $yt=(0.5)*(x{t-1}+xt)$. The mean of $xt$ is 3, the variance of $xt$ is 4, and the correlation between any neighboring $xt$'s is 0.5 (so $cor(xt, x{t-1})=0.5$). $xt$'s more than two time points apart are uncorrelated (correlation is 0). Use the rules for means and variances of linear combinations to find $E(yt)$, $Var(yt)$, and $Cov(yt,y{t-1})$. Do not worry about what happens at the edges of the time series (for t=1 or t=n), only worry about $t$ in general._

  - _Note that you have some preliminary work to complete to go from the provided information to what you need to work on the three derivations requested._
  
__Please see handwritten solutions to this problem. Thanks!__  

##R Version Information
```{r}
getRversion()

```


